From 9f6fc577688437d40d2c8ba493866362a8fb57fa Mon Sep 17 00:00:00 2001
From: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Date: Tue, 11 Mar 2014 17:07:12 -0700
Subject: [PATCH 30/33] coverity scan: Untrusted loop bound

Fix issue error for loop bounds.
---
 src/thd_cdev_cpufreq.cpp | 15 +++++++++++++--
 src/thd_cdev_cpufreq.h   |  4 +++-
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/thd_cdev_cpufreq.cpp b/src/thd_cdev_cpufreq.cpp
index 72b2e28..9c810bd 100644
--- a/src/thd_cdev_cpufreq.cpp
+++ b/src/thd_cdev_cpufreq.cpp
@@ -37,13 +37,24 @@ int cthd_cdev_cpufreq::init() {
 
 		cdev_sysfs.read("present", count_str);
 		p1 = count_str.find_first_of("-", p0);
+		if (p1 == std::string::npos)
+			return THD_ERROR;
+
 		std::string token1 = count_str.substr(p0, p1 - p0);
+		if (token1.empty())
+			return THD_ERROR;
+
 		std::istringstream(token1) >> cpu_start_index;
+		if ((p1 + 1) >= count_str.size())
+			return THD_ERROR;
+
 		std::string token2 = count_str.substr(p1 + 1);
+		if (token2.empty())
+			return THD_ERROR;
+
 		std::istringstream(token2) >> cpu_end_index;
+
 	} else {
-		cpu_start_index = 0;
-		cpu_end_index = 0;
 		return THD_ERROR;
 	}
 	thd_log_debug("pstate CPU present %d-%d\n", cpu_start_index, cpu_end_index);
diff --git a/src/thd_cdev_cpufreq.h b/src/thd_cdev_cpufreq.h
index 70e2182..b21cd16 100644
--- a/src/thd_cdev_cpufreq.h
+++ b/src/thd_cdev_cpufreq.h
@@ -42,7 +42,9 @@ private:
 
 public:
 	cthd_cdev_cpufreq(unsigned int _index, int _cpu_index) :
-			cthd_cdev(_index, "/sys/devices/system/cpu/"), cpu_index(_cpu_index) {
+			cthd_cdev(_index, "/sys/devices/system/cpu/"), cpu_start_index(0), cpu_end_index(
+					0), pstate_active_freq_index(0), turbo_state(0), last_governor(
+					""), cpu_index(_cpu_index) {
 	}
 
 	int init();
-- 
1.9.0

